name: UMVC.Editor

# Ref: https://gist.github.com/chatrat12/9780fffe59bc46a63bc0b9b665489e08

on:
  pull_request:
    branches: [ master ]


jobs:
  test:
    name: Test UMVC.Editor 🧪
    runs-on: ubuntu-latest
    steps:
      - name: Wait for build to succeed
        uses: fountainhead/action-wait-for-check@v1.0.0
        id: wait-for-build
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: Build UMVC.Core 🏗️
          ref: ${{ github.event.pull_request.head.sha }}
          
      - name: Is UMVC.Core failing?
        if: ${{ steps.wait-for-build.outputs.conclusion == 'failure' }}
        run: echo "::error There is a problem with your UMVC.Core build! Exiting!!" && exit 1
      
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install python3-pip unzip curl -y && pip install requests
        
      - name: Download UMVC.Core Build
        run: python .github/workflows/scripts/downloadArtifacts.py ${{ secrets.PERSONAL_TOKEN }}

      - name: Unzip and move UMVC.Core dlls
        run: sh .github/workflows/scripts/install-umvc.editor-deps.sh

      # Test edit mode
      - name: Run playmode tests
        uses: game-ci/unity-test-runner@v2.0.0
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          unityVersion: 2021.2.19f1
          testMode: playmode
          customParameters: |
            -enableCodeCoverage 
            -coverageResultsPath /github/workspace/artifacts/CodeCoverage/ 
            -coverageOptions "assemblyFilters:-*unity*"
            -debugCodeOptimization
      
      # Test play mode
      - name: Run editmode tests
        uses: game-ci/unity-test-runner@v2.0.0
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          unityVersion: 2021.2.19f1
          testMode: editmode
          customParameters: |
            -enableCodeCoverage 
            -coverageResultsPath /github/workspace/artifacts/CodeCoverage/ 
            -coverageOptions "assemblyFilters:-*unity*"
            -debugCodeOptimization
        
      - name: Display files in artifacts/CodeCoverage/
        run: ls -R ./artifacts/CodeCoverage/
      
      - name: Codecov
        uses: codecov/codecov-action@v3.0.0
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./artifacts/CodeCoverage/workspace-opencov/PlayMode/TestCoverageResults_0000.xml,./artifacts/CodeCoverage/workspace-opencov/EditMode/TestCoverageResults_0000.xml
          name: codecov-umbrella
          fail_ci_if_error: true

  SonarCloud_Scan:
    name: Analyse UMVC.Editor with SonarCloud 🧪
    runs-on: ubuntu-latest
    steps:
      - name: Wait for build to succeed
        uses: fountainhead/action-wait-for-check@v1.0.0
        id: wait-for-build
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: Build UMVC.Core 🏗️
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Is UMVC.Core failing?
        if: ${{ steps.wait-for-build.outputs.conclusion == 'failure' }}
        run: echo "::error There is a problem with your UMVC.Core build! Exiting!!" && exit 1
        
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install python3-pip unzip curl -y && pip install requests

      - name: Download UMVC.Core Build
        run: python .github/workflows/scripts/downloadArtifacts.py ${{ secrets.PERSONAL_TOKEN }}

      - name: Unzip and move UMVC.Core dlls
        run: sh .github/workflows/scripts/install-umvc.editor-deps.sh

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v0.9.11
        with:
          versionSpec: '5.x'

      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v0.9.11

      - name: Create .sln files
        uses: game-ci/unity-builder@v2
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          buildMethod: UMVC.Builder.SonarCloudBuilder.SyncSolution
          allowDirtyBuild: true
          
      - name: print current dir
        run: ls

      - name: remove unwanted files
        run: rm -f *.csproj && rm -f UMVC.Core.Build.zip
          
      - name: scan UMVC.Editor with SonarCloud
        uses: docker://shadowbert/unityci:2021.3.3f1-sonarqube-1.0.1
        with: 
          args: >-
            sh -c "
              dotnet tool install --global JetBrains.dotCover.GlobalTool && \
              dotnet sonarscanner begin /k:'UMVC.Editor' \
                /o:'loic-lopez' \
                /n:'UMVC.Editor' \
                /v:'${{ steps.gitversion.outputs.semVer }}' \
                /d:sonar.login='${{ secrets.SONAR_TOKEN_EDITOR }}' \
                /d:sonar.cs.dotcover.reportsPaths=dotCover.Output.html \
                /d:sonar.scm.provider=git \
                /d:sonar.projectDescription='UMVC - Model-View-Controller Generator built for Unity' \
                /d:sonar.host.url=https://sonarcloud.io && \
              dotnet build ../*.sln && \
              dotnet dotcover test --dcReportType=HTML && \ 
              dotnet sonarscanner end /d:sonar.login='${{ secrets.SONAR_TOKEN_EDITOR }}'
            "
