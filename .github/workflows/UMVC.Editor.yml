name: UMVC.Editor

# Ref: https://gist.github.com/chatrat12/9780fffe59bc46a63bc0b9b665489e08

on:
  pull_request:
    branches: [ master ]


jobs:
  test:
    name: Test UMVC.Editor üß™
    runs-on: ubuntu-latest
    steps:
      - name: Wait for build to succeed
        uses: fountainhead/action-wait-for-check@v1.0.0
        id: wait-for-build
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: Build UMVC.Core üèóÔ∏è
          ref: ${{ github.event.pull_request.head.sha }}
          
      - name: Is UMVC.Core failing?
        if: ${{ steps.wait-for-build.outputs.conclusion == 'failure' }}
        run: echo "::error There is a problem with your UMVC.Core build! Exiting!!" && exit 1
      
      - uses: actions/checkout@v2

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install python3-pip unzip curl -y && pip install requests
        
      - name: Download UMVC.Core Build
        run: python .github/workflows/scripts/downloadArtifacts.py ${{ secrets.PERSONAL_TOKEN }}

      - name: Unzip and move UMVC.Core dlls
        run: sh .github/workflows/scripts/install-umvc.editor-deps.sh

      # Test edit mode
      - name: Run playmode tests
        uses: game-ci/unity-test-runner@v2
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          unityVersion: 2020.3.33f1
          testMode: playmode
          customParameters: |
            -enableCodeCoverage 
            -coverageResultsPath /github/workspace/CodeCoverage/ 
            -coverageOptions "assemblyFilters:-*unity*"
            -debugCodeOptimization
      
      # Test play mode
      - name: Run editmode tests
        uses: game-ci/unity-test-runner@v2.0.0
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          unityVersion: 2020.3.33f1
          testMode: editmode
          customParameters: |
            -enableCodeCoverage 
            -coverageResultsPath /github/workspace/CodeCoverage/ 
            -coverageOptions "assemblyFilters:-*unity*"
            -debugCodeOptimization
        
      - name: Display files in /github/workspace/CodeCoverage/
        run: ls -R /github/workspace/CodeCoverage/workspace-opencov/
        
      - name: Codecov
        uses: codecov/codecov-action@v3.0.0
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: /github/workspace/CodeCoverage/workspace-opencov/*Mode/TestCoverageResults_0000.xml
          name: codecov-umbrella
          fail_ci_if_error: true
 