name: UMVC.Editor

# Ref: https://gist.github.com/chatrat12/9780fffe59bc46a63bc0b9b665489e08

on:
  pull_request:
    branches: [ master ]


jobs:
  test:
    name: Test UMVC.Editor üß™
    runs-on: ubuntu-latest
    steps:
      - name: Wait for build to succeed
        uses: fountainhead/action-wait-for-check@v1.0.0
        id: wait-for-build
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: Build UMVC.Core üèóÔ∏è
          ref: ${{ github.event.pull_request.head.sha }}
          
      - name: Is UMVC.Core failing?
        if: ${{ steps.wait-for-build.outputs.conclusion == 'failure' }}
        run: echo "::error There is a problem with your UMVC.Core build! Exiting!!" && exit 1
      
      - uses: actions/checkout@v2

      - name: Install dependencies
        run: apt-get update && apt-get install python-pip unzip curl -y && pip install requests
        
      - name: Download UMVC.Core Build
        run: python .github/workflows/scripts/downloadArtifacts.py ${{ secrets.PERSONAL_TOKEN }}

      - name: Unzip and move UMVC.Core dlls
        run: sh .github/workflows/scripts/install-umvc.editor-deps.sh

      # Test
      - name: Run tests
        uses: game-ci/unity-test-runner@v2
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          unityVersion: 2020.3.33f1
          testMode: all
        
      - name: Codecov
        uses: codecov/codecov-action@master
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./CodeCoverage/UMVC-opencov/EditMode/TestCoverageResults_0000.xml,./CodeCoverage/UMVC-opencov/PlayMode/TestCoverageResults_0000.xml
          name: codecov-umbrella
          fail_ci_if_error: true
#  