name: UMVC.Editor

# Ref: https://gist.github.com/chatrat12/9780fffe59bc46a63bc0b9b665489e08

on:
  pull_request:
    branches: [ master ]


jobs:
  test:
    name: Test UMVC.Editor üß™
    runs-on: ubuntu-latest
    steps:
      - name: Wait for build to succeed
        uses: fountainhead/action-wait-for-check@v1.0.0
        id: wait-for-build
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: Build UMVC.Core üèóÔ∏è
          ref: ${{ github.event.pull_request.head.sha }}
          
      - name: Is UMVC.Core failing?
        if: ${{ steps.wait-for-build.outputs.conclusion == 'failure' }}
        run: echo "::error There is a problem with your UMVC.Core build! Exiting!!" && exit 1
      
      - uses: actions/checkout@v2
      - run: git fetch --prune --unshallow --tags
        
      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v0.9.11
        with:
          versionSpec: '5.x'

      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v0.9.11

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install python3-pip unzip curl -y && pip install requests

      - name: Setup .NET Core
        uses: actions/setup-dotnet@v2
        with:
          dotnet-version: '3.1.x'

      - name: install dotCover
        run: dotnet tool install --global JetBrains.dotCover.GlobalTool

      - name: install dotnet-sonarscanner
        run: dotnet tool install --global dotnet-sonarscanner
        
      - name: Download UMVC.Core Build
        run: python .github/workflows/scripts/downloadArtifacts.py ${{ secrets.PERSONAL_TOKEN }}

      - name: Unzip and move UMVC.Core dlls
        run: sh .github/workflows/scripts/install-umvc.editor-deps.sh

      # Test edit mode
      - name: Run playmode tests
        uses: game-ci/unity-test-runner@v2
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          unityVersion: 2021.2.19f1
          testMode: playmode
          customParameters: |
            -enableCodeCoverage 
            -coverageResultsPath /github/workspace/artifacts/CodeCoverage/ 
            -coverageOptions "assemblyFilters:-*unity*"
            -debugCodeOptimization
      
      # Test play mode
      - name: Run editmode tests
        uses: game-ci/unity-test-runner@v2
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          unityVersion: 2021.2.19f1
          testMode: editmode
          customParameters: |
            -enableCodeCoverage 
            -coverageResultsPath /github/workspace/artifacts/CodeCoverage/ 
            -coverageOptions "assemblyFilters:-*unity*"
            -debugCodeOptimization
        
      - name: Display files in artifacts/CodeCoverage/
        run: ls -R ./artifacts/CodeCoverage/
      
      - name: Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./artifacts/CodeCoverage/workspace-opencov/PlayMode/TestCoverageResults_0000.xml,./artifacts/CodeCoverage/workspace-opencov/EditMode/TestCoverageResults_0000.xml
          name: codecov-umbrella
          fail_ci_if_error: true

      - uses: game-ci/unity-builder@v2
        with:
          buildMethod: UMVC.Builder.SonarCloudBuilder.SyncSolution

      - name: Start SonarCloud scanner for UMVC
        run: |
          dotnet sonarscanner begin /k:"UMVC.Editor" \
            /o:"loic-lopez" \
            /n:"UMVC.Editor" \
            /v:"${{ steps.gitversion.outputs.semVer }}" \
            /d:sonar.login="${{ secrets.SONAR_TOKEN_EDITOR }}" \
            /d:sonar.cs.dotcover.reportsPaths=dotCover.Output.html \
            /d:sonar.scm.provider=git \
            /d:sonar.projectDescription="UMVC - Model-View-Controller Generator built for Unity" \
            /d:sonar.host.url=https://sonarcloud.io

      - name: Build UMVC
        run: dotnet build UMVC.sln

      - name: Test UMVC
        run: dotnet dotcover test --dcReportType=HTML

      - name: End SonarCloud scanner for UMVC
        run: |
          dotnet sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN_EDITOR }}"
 